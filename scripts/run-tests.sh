
#!/bin/bash

echo "üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ WebApp..."

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
composer install --no-dev

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ ! -f .env ]; then
    echo "‚ö†Ô∏è  –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω, –∫–æ–ø–∏—Ä—É–µ–º –∏–∑ .env.example"
    cp .env.example .env
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
echo "üóÑÔ∏è  –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏..."
php scripts/migrate.php

# –ó–∞–ø—É—Å–∫–∞–µ–º PHP Unit —Ç–µ—Å—Ç—ã
echo "üß™ –ó–∞–ø—É—Å–∫ PHPUnit —Ç–µ—Å—Ç–æ–≤..."
vendor/bin/phpunit --configuration tests/phpunit.xml

if [ $? -eq 0 ]; then
    echo "‚úÖ PHPUnit —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!"
else
    echo "‚ùå PHPUnit —Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å!"
    exit 1
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä –≤ —Ñ–æ–Ω–µ –¥–ª—è E2E —Ç–µ—Å—Ç–æ–≤
echo "üåê –ó–∞–ø—É—Å–∫ PHP —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è E2E —Ç–µ—Å—Ç–æ–≤..."
php -S 0.0.0.0:5000 -t public &
SERVER_PID=$!

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
curl -f http://localhost:5000/api/health || {
    echo "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è!"
    kill $SERVER_PID
    exit 1
}

# –ó–∞–ø—É—Å–∫–∞–µ–º Cypress —Ç–µ—Å—Ç—ã (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
if command -v npx &> /dev/null; then
    echo "üîç –ó–∞–ø—É—Å–∫ Cypress E2E —Ç–µ—Å—Ç–æ–≤..."
    npx cypress run
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ Cypress —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!"
    else
        echo "‚ùå Cypress —Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å!"
        kill $SERVER_PID
        exit 1
    fi
else
    echo "‚ö†Ô∏è  Cypress –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º E2E —Ç–µ—Å—Ç—ã"
fi

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä
kill $SERVER_PID

echo "üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
